"""\nEncrypted Reports Handler\nManages encryption/decryption of cyberbullying reports for privacy\n"""\n\nfrom cryptography.fernet import Fernet\nfrom cryptography.hazmat.primitives import hashes\nfrom cryptography.hazmat.primitives.kdf.pbkdf2 import PBKDF2\nfrom cryptography.hazmat.backends import default_backend\nimport base64\nimport json\nfrom datetime import datetime\nimport os\n\nclass EncryptedReportsHandler:\n    """Handler for encrypted cyberbullying reports"""\n    \n    def __init__(self, key_path='keys/encryption.key'):\n        self.key_path = key_path\n        self.cipher = None\n        self.load_or_create_key()\n    \n    def load_or_create_key(self):\n        """Load existing key or create a new encryption key"""\n        try:\n            if os.path.exists(self.key_path):\n                with open(self.key_path, 'rb') as f:\n                    key = f.read()\n                    self.cipher = Fernet(key)\n            else:\n                self.generate_new_key()\n        except Exception as e:\n            print(f'Error loading key: {e}')\n            self.generate_new_key()\n    \n    def generate_new_key(self):\n        """Generate a new encryption key"""\n        key = Fernet.generate_key()\n        os.makedirs(os.path.dirname(self.key_path), exist_ok=True)\n        with open(self.key_path, 'wb') as f:\n            f.write(key)\n        self.cipher = Fernet(key)\n    \n    def encrypt_report(self, report_data):\n        """Encrypt a cyberbullying report"""\n        try:\n            # Convert report to JSON string\n            report_json = json.dumps(report_data)\n            # Encrypt the JSON\n            encrypted = self.cipher.encrypt(report_json.encode())\n            return encrypted.decode()\n        except Exception as e:\n            print(f'Encryption error: {e}')\n            return None\n    \n    def decrypt_report(self, encrypted_data):\n        """Decrypt a cyberbullying report"""\n        try:\n            decrypted = self.cipher.decrypt(encrypted_data.encode())\n            report_data = json.loads(decrypted.decode())\n            return report_data\n        except Exception as e:\n            print(f'Decryption error: {e}')\n            return None\n    \n    def create_report(self, text, severity, confidence, reporter_id=None):\n        """Create and encrypt a report"""\n        report = {\n            'text': text,\n            'severity': severity,\n            'confidence': confidence,\n            'reporter_id': reporter_id,\n            'timestamp': datetime.now().isoformat(),\n            'status': 'pending'\n        }\n        encrypted_report = self.encrypt_report(report)\n        return {\n            'id': self.generate_report_id(),\n            'encrypted_data': encrypted_report,\n            'created_at': datetime.now().isoformat()\n        }\n    \n    def generate_report_id(self):\n        """Generate unique report ID"""\n        import uuid\n        return str(uuid.uuid4())\n    \n    def store_report(self, report, storage_path='reports/'):\n        """Store encrypted report to file"""\n        try:\n            os.makedirs(storage_path, exist_ok=True)\n            report_file = os.path.join(storage_path, f\"report_{report['id']}.json\")\n            with open(report_file, 'w') as f:\n                json.dump(report, f)\n            return report_file\n        except Exception as e:\n            print(f'Storage error: {e}')\n            return None\n    \n    def retrieve_report(self, report_id, storage_path='reports/'):\n        """Retrieve and decrypt a stored report"""\n        try:\n            report_file = os.path.join(storage_path, f\"report_{report_id}.json\")\n            with open(report_file, 'r') as f:\n                report = json.load(f)\n            decrypted_data = self.decrypt_report(report['encrypted_data'])\n            return decrypted_data\n        except Exception as e:\n            print(f'Retrieval error: {e}')\n            return None\n    \n    def batch_encrypt_reports(self, reports):\n        """Encrypt multiple reports"""\n        encrypted_reports = []\n        for report_data in reports:\n            encrypted = self.encrypt_report(report_data)\n            encrypted_reports.append(encrypted)\n        return encrypted_reports\n    \n    def batch_decrypt_reports(self, encrypted_reports):\n        """Decrypt multiple reports"""\n        decrypted_reports = []\n        for encrypted_data in encrypted_reports:\n            decrypted = self.decrypt_report(encrypted_data)\n            decrypted_reports.append(decrypted)\n        return decrypted_reports\n\n\nif __name__ == '__main__':\n    handler = EncryptedReportsHandler()\n    test_report = {\n        'text': 'Test cyberbullying report',\n        'severity': 'high',\n        'confidence': 0.85\n    }\n    encrypted = handler.encrypt_report(test_report)\n    print(f'Encrypted: {encrypted[:50]}...')\n    decrypted = handler.decrypt_report(encrypted)\n    print(f'Decrypted: {decrypted}')\n
